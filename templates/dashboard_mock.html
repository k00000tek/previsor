<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>PreVisor Dashboard (Demo)</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; background-color: #f5f5f5; }
    .card { margin-bottom: 20px; }
    .badge-type { font-size: 0.8rem; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">PreVisor — мониторинг угроз</h1>

  <!-- Панель фильтров -->
  <div class="card mb-4">
    <div class="card-body row g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Тип угрозы</label>
        <select id="filterType" class="form-select">
          <option value="">Все типы</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Минимальный риск, %</label>
        <input type="number" id="filterMinProb" class="form-control" value="80" min="0" max="100">
      </div>
      <div class="col-md-4">
        <button class="btn btn-primary w-100" onclick="applyFilters()">Применить фильтры</button>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- График по типам -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Алерты по типам</div>
        <div class="card-body">
          <div id="typeChart" style="height: 300px;"></div>
        </div>
      </div>
    </div>

    <!-- График по времени -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Алерты по времени</div>
        <div class="card-body">
          <div id="timeChart" style="height: 300px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Таблица алертов -->
  <div class="card mt-4">
    <div class="card-header">Последние алерты</div>
    <div class="card-body">
      <table class="table table-sm table-hover">
        <thead>
        <tr>
          <th>ID</th>
          <th>Время</th>
          <th>Тип</th>
          <th>Риск</th>
          <th>IP</th>
          <th>Статус</th>
        </tr>
        </thead>
        <tbody id="alertsTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // Демоданные для скрина: больше событий, разные типы и часы,
  // чтобы графики выглядели "живыми"
  const allAlerts = [
    {id: 101, timestamp: '2025-11-30T10:05:12', type: 'DDoS',           probability: 0.99, source_ip: '192.168.1.96',  status: 'new'},
    {id: 102, timestamp: '2025-11-30T10:17:43', type: 'DDoS',           probability: 0.97, source_ip: '192.168.1.150', status: 'new'},
    {id: 103, timestamp: '2025-11-30T11:02:21', type: 'Web Attacks',    probability: 0.96, source_ip: '192.168.1.160', status: 'new'},
    {id: 104, timestamp: '2025-11-30T11:15:47', type: 'Web Attacks',    probability: 0.94, source_ip: '192.168.1.200', status: 'acknowledged'},
    {id: 105, timestamp: '2025-11-30T11:48:03', type: 'Brute Force',    probability: 0.93, source_ip: '192.168.1.227', status: 'acknowledged'},
    {id: 106, timestamp: '2025-11-30T12:05:55', type: 'PortScan',       probability: 0.91, source_ip: '192.168.1.175', status: 'new'},
    {id: 107, timestamp: '2025-11-30T12:27:10', type: 'PortScan',       probability: 0.88, source_ip: '192.168.1.180', status: 'new'},
    {id: 108, timestamp: '2025-11-30T13:10:33', type: 'Anomaly',        probability: 0.92, source_ip: '192.168.1.142', status: 'new'},
    {id: 109, timestamp: '2025-11-30T13:44:19', type: 'Anomaly',        probability: 0.89, source_ip: '192.168.1.143', status: 'new'},
    {id: 110, timestamp: '2025-11-30T14:03:47', type: 'DDoS',           probability: 0.98, source_ip: '192.168.1.201', status: 'acknowledged'},
    {id: 111, timestamp: '2025-11-30T14:22:11', type: 'Web Attacks',    probability: 0.95, source_ip: '192.168.1.118', status: 'new'},
    {id: 112, timestamp: '2025-11-30T15:01:05', type: 'Brute Force',    probability: 0.90, source_ip: '192.168.1.250', status: 'new'},
    {id: 113, timestamp: '2025-11-30T15:27:59', type: 'Normal Traffic', probability: 0.10, source_ip: '192.168.1.10',  status: 'ignored'},
    {id: 114, timestamp: '2025-11-30T16:12:44', type: 'Normal Traffic', probability: 0.08, source_ip: '192.168.1.11',  status: 'ignored'}
  ];

  let filteredAlerts = [...allAlerts];

  function initFilterOptions() {
    const types = [...new Set(allAlerts.map(a => a.type))];
    const select = document.getElementById('filterType');
    select.innerHTML = '<option value="">Все типы</option>' +
      types.map(t => `<option value="${t}">${t}</option>`).join('');
  }

  function applyFilters() {
    const type = document.getElementById('filterType').value;
    const minProb = Number(document.getElementById('filterMinProb').value) / 100;

    filteredAlerts = allAlerts.filter(a => {
      const byType = !type || a.type === type;
      const byProb = isNaN(minProb) ? true : a.probability >= minProb;
      return byType && byProb;
    });

    renderTable();
    renderCharts();
  }

  function renderTable() {
    const tbody = document.getElementById('alertsTable');
    tbody.innerHTML = filteredAlerts.map(a => `
      <tr>
        <td>${a.id}</td>
        <td>${new Date(a.timestamp).toLocaleString()}</td>
        <td><span class="badge bg-danger badge-type">${a.type}</span></td>
        <td>${(a.probability * 100).toFixed(1)}%</td>
        <td>${a.source_ip}</td>
        <td>${a.status}</td>
      </tr>
    `).join('');
  }

  function renderCharts() {
    // Распределение по типам
    const countsByType = {};
    filteredAlerts.forEach(a => {
      countsByType[a.type] = (countsByType[a.type] || 0) + 1;
    });

    Plotly.newPlot('typeChart', [{
      x: Object.keys(countsByType),
      y: Object.values(countsByType),
      type: 'bar'
    }], {
      title: 'Количество алертов по типам',
      margin: { t: 40, l: 40, r: 10, b: 40 }
    });

    // Распределение по часам
    const countsByHour = {};
    filteredAlerts.forEach(a => {
      const hour = new Date(a.timestamp).getHours();
      countsByHour[hour] = (countsByHour[hour] || 0) + 1;
    });

    const hours = Object.keys(countsByHour)
      .map(h => Number(h))
      .sort((a, b) => a - b)
      .map(h => h.toString());

    const hourCounts = hours.map(h => countsByHour[h]);

    Plotly.newPlot('timeChart', [{
      x: hours,
      y: hourCounts,
      type: 'bar'
    }], {
      title: 'Алерты по часам',
      xaxis: { title: 'Часы' },
      yaxis: { title: 'Количество алертов' },
      margin: { t: 40, l: 40, r: 10, b: 40 }
    });
  }

  // Инициализация при загрузке
  initFilterOptions();
  applyFilters();
</script>
</body>
</html>
