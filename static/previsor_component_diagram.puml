@startuml
title Диаграмма компонентов PreVisor

skinparam componentStyle rectangle
skinparam rectangle {
  BackgroundColor White
  BorderColor #777
  FontColor Black
}
skinparam package {
  BackgroundColor #F9F9F9
  BorderColor #999
}
skinparam database {
  BackgroundColor #FFF9F2
  BorderColor #CCAA77
}
skinparam cloud {
  BackgroundColor #F5FAFF
  BorderColor #8FB6E6
}

package "Core System" {
  [Threat Pipeline\n(modules.pipeline)]
  [Data Collector\n(modules.data_collector)]
  [Preprocessor\n(modules.preprocessor)]
  [Heuristics\n(modules.heuristics)]

  package "Threat Analysis" {
    [Classifier Analyzer\n(modules.analyzer)]
    [Anomaly Detector\n(modules.anomaly_detector)]
    [API Integration\n(utils.api_integration)]
  }

  [Baseline Manager\n(modules.baseline_manager)]
}

package "Presentation Layer" {
  [Flask Web App\n(app.py, templates/dashboard.html)]
}

package "Runtime Monitor (app.py)" {
  [Collector Thread]
  [Processor Thread]
  [In-Memory Queue\n(queue.Queue)]
  [Telegram Polling Thread]
}

database "Data Storage" {
  [SQLite DB\n(db/runtime/previsor.db)]
}

cloud "External Services (Optional)" {
  [Threat Intelligence API\n(AbuseIPDB)]
  [Telegram Bot API\n(api.telegram.org)]
}

' === Связи ===
[Collector Thread] --> [Data Collector\n(modules.data_collector)] : capture traffic
[Data Collector\n(modules.data_collector)] --> [In-Memory Queue\n(queue.Queue)] : raw batch
[In-Memory Queue\n(queue.Queue)] --> [Processor Thread] : dequeue batch
[Processor Thread] --> [Threat Pipeline\n(modules.pipeline)] : batch analysis

[Threat Pipeline\n(modules.pipeline)] --> [Preprocessor\n(modules.preprocessor)] : feature matrix
[Threat Pipeline\n(modules.pipeline)] --> [Heuristics\n(modules.heuristics)] : raw rows
[Threat Pipeline\n(modules.pipeline)] --> [Classifier Analyzer\n(modules.analyzer)] : classification
[Threat Pipeline\n(modules.pipeline)] --> [Anomaly Detector\n(modules.anomaly_detector)] : anomalies

[Threat Pipeline\n(modules.pipeline)] --> [SQLite DB\n(db/runtime/previsor.db)] : traffic_logs
[API Integration\n(utils.api_integration)] --> [SQLite DB\n(db/runtime/previsor.db)] : ip_cache

[Flask Web App\n(app.py, templates/dashboard.html)] --> [SQLite DB\n(db/runtime/previsor.db)] : alerts/logs CRUD
[Flask Web App\n(app.py, templates/dashboard.html)] --> [Threat Pipeline\n(modules.pipeline)] : manual analysis
[Flask Web App\n(app.py, templates/dashboard.html)] --> [Collector Thread] : start/stop monitor
[Flask Web App\n(app.py, templates/dashboard.html)] --> [Baseline Manager\n(modules.baseline_manager)] : retrain IF from DB
[Baseline Manager\n(modules.baseline_manager)] --> [SQLite DB\n(db/runtime/previsor.db)] : read traffic_logs + alert statuses

[Classifier Analyzer\n(modules.analyzer)] --> [API Integration\n(utils.api_integration)] : check IP reputation
[API Integration\n(utils.api_integration)] --> [Threat Intelligence API\n(AbuseIPDB)] : HTTP requests

[Flask Web App\n(app.py, templates/dashboard.html)] --> [Telegram Bot API\n(api.telegram.org)] : sendMessage (alerts)
[Telegram Polling Thread] --> [Telegram Bot API\n(api.telegram.org)] : getUpdates (commands)
[Telegram Polling Thread] --> [Flask Web App\n(app.py, templates/dashboard.html)] : handle /start,/selectchat,...

@enduml
