@startuml
'https://plantuml.com/activity-diagram
title Диаграмма деятельности PreVisor

|Система|
start
:Сбор данных из сети (real-трафик);
:Непрерывный мониторинг (2 потока: сбор + обработка);
:Поток-коллектор формирует батчи и кладет в очередь;
:Поток-обработчик извлекает батчи для анализа;
:Предобработка (очистка, нормализация, feature engineering);
:Анализ угроз (ML-классификатор + эвристики + IsolationForest);
:Опционально: обогащение репутацией IP (AbuseIPDB);
:Запись трафика в журнал (traffic_logs);

if (Обнаружен риск выше порога?) then (Да)
  :Генерация алерта (JSON);
  :Сохранение в БД (alerts);
  :Отправка уведомления в Telegram;
  :Кэширование репутации IP (ip_cache);
endif
:Проверка условия дообучения IsolationForest\n(baseline из БД, исключая угрозы;\nfalse_positive возвращается в baseline);
:Обновление дашборда;

|Пользователь|
:Открытие веб-интерфейса;
:Просмотр алертов и статистики;
:Старт/стоп мониторинга (при необходимости);
:Нажатие "Накопить baseline (БД)" для ускоренного накопления baseline;
if (Нужен ручной запуск?) then (Да)
  :Нажатие "Разовый анализ";
  :Flask инициирует сбор/предобработку
  и повторный анализ данных;
endif
:Обновление статусов алертов;
:При статусе false_positive — трафик учитывается\nкак baseline-кандидат для дообучения;
:Продолжение мониторинга;

|Внешние источники|
:Threat Intelligence (AbuseIPDB, опционально);

stop
@enduml
