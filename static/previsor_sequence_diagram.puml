@startuml
title Диаграмма последовательности PreVisor:\nАвтоматический мониторинг и ручной анализ

actor "Пользователь" as User
participant "Flask UI\n(Веб-интерфейс)" as Flask
participant "Сборщик данных\n(DataCollector)" as DC
participant "Предобработка\n(Preprocessor)" as PP
participant "Анализатор\n(Analyzer + AnomalyDetector)" as AN
participant "База данных\n(DB)" as DB
participant "Threat Intelligence\n(API)" as EXT

loop Каждые 10 минут (Celery beat)
  DC -> DC : collect_traffic()\nСбор трафика
  DC -> PP : preprocess_data(raw_logs)\nПредобработка
  PP -> AN : analyze(features)\nML-классификация
  AN -> AN : detect_anomalies(features)\nIsolationForest
  AN -> EXT : check_ip(ip)\nПроверка репутации (AbuseIPDB)
  AN -> AN : combine_signals()\nрасчёт интегрального риска

  alt Риск выше порога
    AN -> DB : insertAlert(alert_json)\nСохранить алерт (alerts)
  else Нет угроз
    AN -> DB : insertLog(clean_results)\nСохранить журнал (traffic_logs)
  end
end

User -> Flask : requestDashboard()\nОткрыть дашборд
Flask -> DB : getAlerts(filters)\nЗапрос алертов
DB --> Flask : list_alerts\nРезультаты
Flask --> User : renderDashboard(alerts)\nОтображение данных

opt Ручной запуск анализа
  User -> Flask : triggerAnalysis(upload/file)\nЗапустить анализ вручную
  Flask -> PP : preprocess_data(file)\nПредобработка файла
  PP -> AN : analyze(features)\nML-анализ + аномалист
  AN -> DB : insertAlert(alert)\nСохранить результат
  Flask --> User : showNewAlert()\nПоказать новый алерт
end

@enduml
